name: Publish NPM Package

# Trigger this workflow ONLY after the "Build font and specimen" workflow completes
on:
  workflow_run:
    workflows: ["Build font and specimen"]
    types:
      - completed

permissions:
  contents: read
  packages: write

jobs:
  npm-publish:
    # Only run if the build was successful
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com/'
          scope: '@YOUR-USERNAME' # REPALCE WITH YOUR GITHUB USERNAME

     # ---------------------------------------------------------
      # 1. Download & Unzip
      # ---------------------------------------------------------
      - name: Download and Unpack Artifacts
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: ./temp_artifacts

      - name: Prepare Distribution Folder
        run: |
          # 1. Create a clean dist folder
          mkdir -p dist
          
          # 2. Unzip all found zip files into a temp folder
          mkdir -p temp_unzip
          find ./temp_artifacts -name "*.zip" -exec unzip -o {} -d temp_unzip \;
          
          # 3. DEBUG: Show us what was inside the zip (Check logs if this fails again)
          echo "=== Content of Zip Files ==="
          ls -R temp_unzip
          
          # 4. FLATTEN: Find any .woff2/.woff files recursively and move them to dist/
          #    This ignores folder structure and dumps all fonts into dist/
          find temp_unzip -type f \( -name "*.woff2" -o -name "*.woff" \) -exec mv {} dist/ \;
          
          # 5. Verify dist folder isn't empty
          echo "=== Final Dist Content ==="
          ls -l dist
          
          # fail if dist is empty
          if [ -z "$(ls -A dist)" ]; then
             echo "Error: Dist folder is empty! No fonts found."
             exit 1
          fi

# ---------------------------------------------------------
      # 3. Configure package.json on the fly
      # ---------------------------------------------------------
      - name: Configure Package
        if: env.SKIP != 'true'
        run: |
          # 1. Create a fresh package.json
          # REPLACE @YOUR-USERNAME WITH YOUR ACTUAL GITHUB USERNAME
          npm init -y --scope=@YOUR-USERNAME
          
          # 2. Configure necessary fields
          npm pkg set description="Open source font build"
          npm pkg set main="index.css"
          npm pkg set style="index.css"
          
          # 3. Tell npm exactly what files to include
          # We need to include the 'dist' folder (where we unzipped fonts) 
          # and 'index.css' (which we will generate next)
          npm pkg set files[]="dist"
          npm pkg set files[]="index.css"
          
          # 4. Set the registry to GitHub Packages
          npm pkg set publishConfig.registry="https://npm.pkg.github.com/"

          # 5. NOW we can set the version
          npm version ${{ env.NPM_VERSION }} --no-git-tag-version --allow-same-version

      # ---------------------------------------------------------
      # 4. Generate CSS (Optional but recommended)
      # ---------------------------------------------------------
      - name: Generate CSS
        if: env.SKIP != 'true'
        run: |
           # Create a basic CSS file mapping the fonts in 'dist'
           # Add your node script here or run a simple shell loop
           echo "/* Auto-generated font face */" > index.css

      # ---------------------------------------------------------
      # 5. Publish
      # ---------------------------------------------------------
      - name: Publish to GitHub Packages
        if: env.SKIP != 'true'
        # Add --dry-run. This runs everything but stops before uploading.
        run: npm publish --tag ${{ env.NPM_TAG }} --dry-run
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
