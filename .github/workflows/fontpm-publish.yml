name: Publish to NPM

on:
  workflow_run:
    workflows: ["Build font and specimen"]
    types:
      - completed

permissions:
  contents: read
  packages: write

jobs:
  npm-publish:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com/'
          scope: '@YOUR-USERNAME'

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: ./temp_artifacts

      - name: Prepare Distribution Folder
        run: |
          mkdir -p dist
          echo "=== Moving Font Files ==="
          find temp_artifacts -type f \( -name "*.woff2" -o -name "*.woff" -o -name "*.ttf" -o -name "*.otf" \) -exec mv -v {} dist/ \;
          
          # Copy License if it exists
          [ -f "OFL.txt" ] && cp OFL.txt dist/ || echo "OFL.txt not found"

          if [ -z "$(ls -A dist)" ]; then
             echo "Error: No fonts found!"
             exit 1
          fi

      - name: Set Version and Channel
        id: meta
        run: |
          REF_NAME=${{ github.event.workflow_run.head_branch }}
          SHA_SHORT=$(echo ${{ github.event.workflow_run.head_sha }} | cut -c1-7)
          DATE_STR=$(date +'%Y%m%d')

          if [[ "$REF_NAME" == v* ]]; then
            VERSION=${REF_NAME#v}
            NPM_TAG="latest"
          elif [[ "$REF_NAME" == "main" ]]; then
            VERSION="0.0.0-nightly-$DATE_STR"
            NPM_TAG="nightly"
          elif [[ "$REF_NAME" == "dev" ]]; then
            VERSION="0.0.0-dev-$SHA_SHORT"
            NPM_TAG="dev"
          else
            echo "SKIP=true" >> $GITHUB_ENV
            exit 0
          fi
          echo "NPM_VERSION=$VERSION" >> $GITHUB_ENV
          echo "NPM_TAG=$NPM_TAG" >> $GITHUB_ENV

      - name: Configure Package
        if: env.SKIP != 'true'
        run: |
          npm init -y --scope=@YOUR-USERNAME
          npm pkg set description="Open source font build"
          npm pkg set main="index.css"
          npm pkg set style="index.css"
          npm pkg set files[]="dist"
          npm pkg set files[]="index.css"
          npm pkg set publishConfig.registry="https://npm.pkg.github.com/"
          npm version ${{ env.NPM_VERSION }} --no-git-tag-version --allow-same-version

      - name: Generate CSS
        if: env.SKIP != 'true'
        run: |
          echo "/* Auto-generated font face */" > index.css
          shopt -s nullglob
          for file in dist/*.woff2; do
            filename=$(basename "$file" .woff2)
            cat <<EOF >> index.css
          @font-face {
            font-family: "${filename}";
            src: url("./dist/${filename}.woff2") format("woff2");
            font-weight: normal;
            font-style: normal;
            font-display: swap;
          }
          EOF
          done

      - name: Publish to GitHub Packages
        if: env.SKIP != 'true'
        run: npm publish --tag ${{ env.NPM_TAG }} --dry-run
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
